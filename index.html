<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</title>
<style>
/* ======== å…¨ç«™é¢¨æ ¼ ======== */
body{
    font-family:"Microsoft JhengHei",Arial,sans-serif;
    margin:0;padding:0;background:#f5f5f5;
}
header{
    background:#7ed6df;color:white;padding:1.2em;
    text-align:center;
    box-shadow:0 2px 5px rgba(0,0,0,0.2);
}
header h1{margin:0;font-size:1.6em;}
header p{margin:0.3em 0 0;font-size:0.95em;}
.container{width:95%;max-width:1200px;margin:1.5em auto;}
.categories{
    display:flex;gap:0.4em;flex-wrap:wrap;
    justify-content:center;margin-bottom:1em;
}
.category-btn{
    padding:0.5em 1em;background:#7ed6df;border:none;
    cursor:pointer;border-radius:20px;
    transition:0.3s;font-weight:500;font-size:0.9em;color:white;
}
.category-btn:hover{ background:#63c5b5;color:white; }
.category-btn.active{ box-shadow:0 2px 5px rgba(0,0,0,0.2); }

/* ======== å•†å“å¡ç‰‡ ======== */
.products{
    display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:0.8em;
}
.product-card{
    background:white;
    border-radius:12px;
    padding:0.8em;
    border:2px solid #ccc;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    transition:0.3s;
    display:flex; flex-direction:column;
}
.product-card:hover{
    transform:translateY(-3px);
    box-shadow:0 4px 16px rgba(0,0,0,0.15);
}
.product-card img{
    width:100%;height:140px;object-fit:cover;border-radius:8px;
}
.product-card h3{margin:0.4em 0 0.2em 0;font-size:1em;}
.product-card p{margin:0.2em 0;font-size:0.85em;color:#555;}
.product-card .price{ font-weight:bold;color:#ff5757; }
.quantity-control{margin-top:0.4em;display:flex;align-items:center;gap:5px;}
.quantity-control button{
    width:32px;height:32px;border:none;
    background:#7ed6df;color:white;font-size:1.1em;
    border-radius:5px;cursor:pointer;font-weight:bold;
}
.add-cart{
    width:36px;height:36px;border-radius:6px;
    background:#B22222;color:white;cursor:pointer;
}

/* ======== è³¼ç‰©æ¢ ======== */
#cartBar{
    position:fixed;
    bottom:0;left:0;
    width:100%;
    display:none;
    padding:0.8em 1em;
    background:#ffffffee;
    backdrop-filter:blur(6px);
    box-shadow:0 -4px 20px rgba(0,0,0,0.25);
    border-top-left-radius:20px;
    border-top-right-radius:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
#cartLeft{
    width:50%;
    text-align:left;
    font-size:1.1em;
}
#cartLeft .label{color:#222;font-weight:bold;}
#cartLeft .amount{color:red;font-weight:bold;font-size:1.15em;}
#cartRight{
    width:50%;
    display:flex;justify-content:flex-end;
}
#viewCartBtn{
    padding:0.6em 2em;
    border:none;cursor:pointer;
    font-size:1.05em;font-weight:bold;
    color:white;
    background:linear-gradient(90deg,#ff7676,#ff3c3c);
    border-radius:40px;
    box-shadow:0 4px 10px rgba(255,60,60,0.35);
    transition:0.25s;
}
#viewCartBtn:hover{
    transform:scale(1.05);
    box-shadow:0 6px 14px rgba(255,60,60,0.5);
}

/* ======== Modal å¡ç‰‡å¼ ======== */
.modal{
    display:none;position:fixed;top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.6);
    align-items:flex-start;
    justify-content:center;padding-top:6%;
}
.modal-content{
    background:white;padding:1.5em;border-radius:16px;
    max-width:500px;width:90%;box-shadow:0 8px 25px rgba(0,0,0,0.25);
    display:flex;flex-direction:column;gap:1em;
}
.modal-close{
    float:right;font-size:1.4em;color:red;cursor:pointer;
}
.section-title{
    font-weight:bold;font-size:1.1em;border-bottom:1px solid #eee;
    padding-bottom:0.3em;margin-bottom:0.5em;
}
.cart-items{display:flex; flex-direction:column; gap:0.8em; max-height:200px; overflow-y:auto;}
.cart-item{
    display:flex;align-items:center;background:#f9f9f9;
    padding:0.5em;border-radius:10px;gap:0.5em;
}
.cart-item img{width:60px;height:60px;object-fit:cover;border-radius:6px;}
.item-info{flex:1;display:flex;flex-direction:column;}
.item-name{font-weight:bold;}
.item-qty{font-size:0.9em;color:#555;}
.item-subtotal{font-weight:bold;color:#ff5757;}
.total{display:flex;justify-content:flex-end;font-weight:bold;font-size:1.1em;padding-top:0.5em;border-top:1px solid #eee;}
.form-select{padding:0.5em;border-radius:10px;border:1px solid #ccc;font-size:1em;width:100%;background:#fdfdfd;}
.delivery-card{background:#f9f9f9;border-radius:12px;padding:0.8em;display:flex;flex-direction:column;gap:0.5em;}
.delivery-card .row{display:flex;gap:0.5em;}
.delivery-card input{flex:1;padding:0.5em;border-radius:8px;border:1px solid #ccc;}
.btn-checkout{
    width:100%;padding:0.7em;border:none;border-radius:12px;
    font-weight:bold;font-size:1em;color:white;
    background:linear-gradient(90deg,#7ed6df,#22a6b3);
    cursor:pointer;transition:0.3s;
}
.btn-checkout:hover{transform:scale(1.03);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<header>
    <h1>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</h1>
    <p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>

<div class="container">
    <div id="categoryContainer" class="categories"></div>
    <div id="productContainer" class="products"></div>
</div>

<!-- è³¼ç‰©æ¢ -->
<div id="cartBar">
    <div id="cartLeft">
        <span class="label">è¨‚å–®å°è¨ˆï¼š</span>
        <span id="cartAmount" class="amount">0 å…ƒ</span>
    </div>
    <div id="cartRight">
        <button id="viewCartBtn">æŸ¥çœ‹ | çµå¸³</button>
    </div>
</div>

<!-- è³¼ç‰©è»Š Modal -->
<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>

    <h3 class="section-title">è³¼ç‰©è»Šå…§å®¹</h3>
    <div id="cartItems" class="cart-items"></div>
    <div class="total">
      <span>ç¸½é¡ï¼š</span>
      <span id="cartTotal">0 å…ƒ</span>
    </div>

    <h4 class="section-title">ä»˜æ¬¾æ–¹å¼</h4>
    <select id="paymentMethod" class="form-select">
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="ç¾é‡‘">ç¾é‡‘</option>
      <option value="Line Pay">Line Pay</option>
    </select>

    <h4 class="section-title">å–è²¨æ–¹å¼</h4>
    <select id="deliveryMethod" class="form-select">
      <option value="" disabled selected>è«‹é¸æ“‡</option>
      <option value="è‡ªå–">è‡ªå–</option>
      <option value="å¤–é€">å¤–é€</option>
    </select>

    <div id="deliveryForm" class="delivery-card">
      <h4>æ”¶ä»¶äººè³‡æ–™</h4>
      <div class="row">
        <input id="receiverName" placeholder="å§“å">
        <input id="receiverPhone" placeholder="é›»è©±">
      </div>
      <input id="receiverAddress" placeholder="åœ°å€">
    </div>

    <button id="checkoutBtn" class="btn-checkout">ç¢ºèªçµå¸³</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz_VaPxbndfTGn7AD7172q0WnqvqRW4c_corHHSQl4PS8L2xAQbt9vjr7hnGnhijkY/exec";

let products = [];
let categories = [];
let cart = [];
let userId = "";
let userName = "";
let pickupStores = [];

/* ================================ LIFF åˆå§‹åŒ– ================================ */
async function initLIFF() {
    await liff.init({ liffId: "2008573741-WGE2G7lZ" });
    if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        userId = profile.userId;
        userName = profile.displayName;
        document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
    } else { liff.login(); }
}

/* ================================ æŠ“å–å•†å“ & é–€å¸‚ ================================ */
async function fetchProducts() {
    try {
        const res = await fetch(API_URL + "?action=products");
        products = await res.json();
        categories = [...new Set(products.map(p => p["é¡åˆ¥"]))].filter(Boolean);
        renderCategories();
        if (categories[0]) renderProducts(categories[0]);

        const storeRes = await fetch(API_URL + "?action=stores");
        pickupStores = await storeRes.json();
        const storeSelect = document.getElementById("pickupStore");
        if(storeSelect) pickupStores.forEach(s => storeSelect.appendChild(new Option(s,s)));
    } catch (e) { console.error("æŠ“å–å•†å“æˆ–é–€å¸‚å¤±æ•—:", e); }
}

/* ================================ æ¸²æŸ“åˆ†é¡æŒ‰éˆ• ================================ */
function renderCategories() {
    const container = document.getElementById("categoryContainer");
    container.innerHTML = "";
    categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat; btn.className = "category-btn";
        btn.onclick = () => {
            document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            renderProducts(cat);
        };
        container.appendChild(btn);
    });
    if(container.firstChild) container.firstChild.classList.add("active");
}

/* ================================ æ¸²æŸ“å•†å“ ================================ */
function renderProducts(category) {
    const container = document.getElementById("productContainer");
    container.innerHTML = "";
    products.filter(p=>p["é¡åˆ¥"]?.trim()===category?.trim()).forEach(p=>{
        const idName = encodeURIComponent(p["å•†å“åç¨±"]);
        const card = document.createElement("div"); card.className="product-card";
        card.innerHTML=`
            <img src="${p["å•†å“ç…§ç‰‡"]}" alt="${p["å•†å“åç¨±"]}">
            <h3>${p["å•†å“åç¨±"]}</h3>
            <p>${p["ç‰¹è‰²èªªæ˜"]||''}</p>
            <p>å–®ä½ï¼š${p["å–®ä½"]}</p>
            <p class="price">${p["å”®åƒ¹"]} å…ƒ</p>
            <p class="quantity-control">
                <button onclick="changeQty('${idName}', -1)">-</button>
                <span id="qty-${idName}">1</span>
                <button onclick="changeQty('${idName}', 1)">+</button>
                <button class="add-cart" onclick="addToCartWithAnimation('${idName}', this)">ğŸ›’</button>
            </p>
        `;
        container.appendChild(card);
    });
}

/* ================================ æ•¸é‡ Â± ================================ */
function changeQty(idName, delta) {
    const span=document.getElementById(`qty-${idName}`);
    let qty=parseInt(span.textContent); qty+=delta;
    if(qty<1) qty=1;
    span.textContent=qty;
    span.style.transition="0.2s"; span.style.transform="scale(1.3)";
    setTimeout(()=>span.style.transform="scale(1)",200);
    const name=decodeURIComponent(idName);
    const exist=cart.find(c=>c.name===name);
    if(exist){ exist.quantity=qty; updateCartBar(); }
}

/* ================================ åŠ å…¥è³¼ç‰©è»Šå‹•ç•« ================================ */
function addToCartWithAnimation(idName, btn){
    const name=decodeURIComponent(idName);
    const qty=parseInt(document.getElementById(`qty-${idName}`).textContent);
    const product=products.find(p=>p["å•†å“åç¨±"]===name);
    const existIndex=cart.findIndex(c=>c.name===name);

    // é£›å…¥å‹•ç•«
    const img=btn.closest(".product-card").querySelector("img");
    const cartBar=document.getElementById("cartBar");
    if(img && cartBar){
        const clone=img.cloneNode(true);
        const imgRect=img.getBoundingClientRect();
        const cartRect=cartBar.getBoundingClientRect();
        clone.style.position="fixed";
        clone.style.top=imgRect.top+"px";
        clone.style.left=imgRect.left+"px";
        clone.style.width=imgRect.width+"px";
        clone.style.height=imgRect.height+"px";
        clone.style.borderRadius="8px";
        clone.style.zIndex=99999;
        clone.style.transition="0.7s cubic-bezier(0.6,0,0.35,1), opacity 0.7s";
        document.body.appendChild(clone);
        requestAnimationFrame(()=>{
            const dx=cartRect.left+cartRect.width/2-(imgRect.left+imgRect.width/2);
            const dy=cartRect.top-(imgRect.top+imgRect.height/2);
            clone.style.transform=`translate(${dx}px,${dy}px) scale(0.1)`;
            clone.style.opacity=0;
        });
        clone.addEventListener("transitionend",()=>clone.remove());
    }

    if(existIndex!==-1){ cart[existIndex].quantity+=qty; }
    else{ cart.push({name, price:parseInt(product["å”®åƒ¹"]), quantity:qty, category:product["é¡åˆ¥"]}); }
    btn.classList.add("active");
    updateCartBar();
}

/* ================================ æ›´æ–°è³¼ç‰©æ¢ ================================ */
function updateCartBar(){
    const bar=document.getElementById("cartBar");
    if(cart.length===0){ bar.style.display="none"; return; }
    const totalAmt=cart.reduce((sum,i)=>sum+i.price*i.quantity,0);
    document.getElementById("cartAmount").textContent=totalAmt+" å…ƒ";
    bar.style.display="flex";
}

/* ================================ æ‰“é–‹/é—œé–‰ Modal ================================ */
const cartModal=document.getElementById("cartModal");
document.getElementById("cartClose").onclick=()=>cartModal.style.display="none";
document.getElementById("viewCartBtn").onclick=()=>{
    renderCart(); cartModal.style.display="flex";
}

/* ================================ æ¸²æŸ“è³¼ç‰©è»Šå…§å®¹ ================================ */
function renderCart(){
    const container=document.getElementById("cartItems");
    container.innerHTML="";
    let total=0;
    cart.forEach(item=>{
        const subtotal=item.price*item.quantity; total+=subtotal;
        const div=document.createElement("div"); div.className="cart-item";
        div.innerHTML=`
            <img src="https://via.placeholder.com/60" alt="${item.name}">
            <div class="item-info">
                <p class="item-name">${item.name}</p>
                <p class="item-qty">${item.quantity} x ${item.price} å…ƒ</p>
            </div>
            <p class="item-subtotal">${subtotal} å…ƒ</p>
        `;
        container.appendChild(div);
    });
    document.getElementById("cartTotal").textContent=total;
    updateCartBar();
}

/* ================================ å¤–é€è‡ªå‹•å¡«å…¥èˆŠè³‡æ–™ ================================ */
async function fetchUserData(){
    if(!userId) return;
    const res=await fetch(API_URL+"?action=getUser&userId="+userId);
    const result=await res.json();
    if(result.user){
        document.getElementById("receiverName").value=result.user.name||"";
        document.getElementById("receiverPhone").value=result.user.phone||"";
        document.getElementById("receiverAddress").value=result.user.address||"";
    }
}

/* ================================ å–è²¨æ–¹å¼åˆ‡æ› ================================ */
document.getElementById("deliveryMethod").onchange=function(){
    const v=this.value;
    if(v==="è‡ªå–"){ document.getElementById("selfPickup")?.style.display="block"; document.getElementById("deliveryForm").style.display="none"; }
    else if(v==="å¤–é€"){ document.getElementById("selfPickup")?.style.display="none"; document.getElementById("deliveryForm").style.display="flex"; fetchUserData(); }
    else{ document.getElementById("selfPickup")?.style.display="none"; document.getElementById("deliveryForm").style.display="none"; }
}

/* ================================ çµå¸³ ================================ */
document.getElementById("checkoutBtn").onclick=async function(){
    if(cart.length===0){ alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼"); return; }
    const payment=document.getElementById("paymentMethod").value;
    const delivery=document.getElementById("deliveryMethod").value;
    const name=document.getElementById("receiverName").value;
    const phone=document.getElementById("receiverPhone").value;
    const address=document.getElementById("receiverAddress").value;
    if(!payment || !delivery){ alert("è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼èˆ‡å–è²¨æ–¹å¼ï¼"); return; }
    if(delivery==="å¤–é€" && (!name || !phone || !address)){ alert("è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶äººè³‡æ–™ï¼"); return; }

    const payload={ userId,userName,cart,payment,delivery,name,phone,address };
    try{
        await fetch(API_URL,{
            method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)
        });
        alert("è¨‚å–®å·²é€å‡ºï¼");
        cart=[]; updateCartBar(); renderCart(); cartModal.style.display="none";
    }catch(e){ alert("è¨‚å–®é€å‡ºå¤±æ•—:"+e); }
}

/* ================================ åˆå§‹åŒ– ================================ */
window.onload=function(){
    initLIFF();
    fetchProducts();
};
</script>

</body>
</html>















































































































































































































































































































































































































































































































































































































































































































































































































































































































































<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</title>
<style>
/* ---------- åŸºæœ¬æ¨£å¼ ---------- */
body{font-family:"Microsoft JhengHei",Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;}
header{background:#7ed6df;color:white;padding:1.2em;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
header h1{margin:0;font-size:1.6em;}
header p{margin:0.3em 0 0 0;font-size:0.95em;}
.container{width:95%;max-width:1200px;margin:1.5em auto;}
.categories{display:flex;gap:0.4em;flex-wrap:wrap;margin-bottom:1em;justify-content:center;}
.category-btn{padding:0.5em 1em;background:#eee;border:none;cursor:pointer;border-radius:20px;transition:0.3s;font-weight:500;font-size:0.9em;}
.category-btn:hover{background:#7ed6df;color:white;}
.category-btn.active{background:#7ed6df;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.8em;}
.product-card{background:white;border-radius:8px;padding:0.8em;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;flex-direction:column;transition:0.3s;position:relative;overflow:hidden;font-size:0.9em;border:2px solid #ccc;}
.product-card:hover{transform:translateY(-2px);box-shadow:0 3px 12px rgba(0,0,0,0.2);}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px;transition:0.3s;}
.product-card:hover img{transform:scale(1.03);}
.product-card h3{margin:0.4em 0 0.2em 0;font-size:1em;}
.product-card p{margin:0.2em 0;font-size:0.85em;color:#555;}
.product-card .price{font-weight:bold;color:#ff6b6b;margin-top:0.4em;}
.quantity-control {display: flex;align-items: center;gap: 10px;margin: 0.6em 0;}
.quantity-control button {width: 30px;height: 30px;background: #7ed6df;color: #1b1b1b;font-size: 1.45em;font-weight: bold;display: flex;align-items: center;justify-content: center;border: none;border-radius: 8px;cursor: pointer;box-shadow: 0 2px 6px rgba(0,0,0,0.18);transition: 0.15s;}
.quantity-control button:active {transform: scale(0.9);}
.quantity-control span {min-width: 40px;height: 26px;background: #fff;border: 1px solid #bbb;border-radius: 8px;display: flex;align-items: center;justify-content: center;font-size: 0.95em;font-weight: 400;color: #333;box-shadow: 0 2px 4px rgba(0,0,0,0.10);}
.add-cart {width: 46px;height: 46px;background: #ff6b6b !important;border-radius: 10px;display: flex;align-items: center;justify-content: center;font-size: 1.55em;color: #fff;border: none;cursor: pointer;box-shadow: 0 3px 10px rgba(0,0,0,0.22);transition: 0.15s;}
.add-cart:hover {transform: scale(1.08);}
.add-cart:active {transform: scale(0.92);}
.add-cart.active {background: #4CAF50 !important;box-shadow: 0 3px 12px rgba(0,0,0,0.28);}
#cartBar {position: fixed;left: 0;bottom: 0;width: 100%;height: 60px;background: #ccc;box-shadow: 0 -2px 8px rgba(0,0,0,0.3);display: flex;align-items: center;font-weight: bold;font-size: 0.95em;z-index: 999;padding: 0 10px;}
#cartBar div { display:flex; align-items:center; height:100%; }
#viewCartBtn {border:none; border-radius:20px; padding:0.48em 1.44em; cursor:pointer;font-weight:bold; background:#fb9d9e; color:white; transition:0.3s; transform: scale(1.2);}
#viewCartBtn:hover { background:#ff4d4d; }
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:flex-start;padding-top:5%;z-index:9999;}
.modal-content{background:white;padding:1.5em;border-radius:12px;max-height:90%;overflow-y:auto;width:95%;position:relative;font-size:0.9em;}
.modal-close{position:absolute;top:10px;right:12px;cursor:pointer;color:red;font-weight:bold;font-size:1.2em;}
#cartItems div{padding:0.3em 0;border-bottom:1px solid #eee;}
#cartItems div:last-child{border:none;}
select,input{width:100%;padding:0.5em;margin:0.2em 0;border-radius:6px;border:1px solid #ccc;font-size:0.9em;}
button#checkoutBtn {width: 100%;padding:0.6em;font-size:1em;font-weight:bold;border-radius:8px;border:none;background:#7ed6df;color:white;cursor:pointer;}
button#checkoutBtn:hover { background: #63c5b5;}
@media (max-width:600px){
.products{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.6em;}
.product-card img{height:120px;}
.category-btn{padding:0.5em 0.8em;font-size:0.85em;}
header h1{font-size:1.4em;}
header p{font-size:0.85em;}
}

/* ---------- è¼‰å…¥ä¸­å‹•ç•« ---------- */
#loadingOverlay {
  position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:10000; font-size:1.2em; color:#333;
}
#loadingOverlay span {
  display:inline-block;
  animation: blink 1.2s linear infinite;
}
@keyframes blink {0%,100%{opacity:1;}50%{opacity:0.3;}}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div id="loadingOverlay"><span>è¼‰å…¥ä¸­...</span></div>

<header>
<h1>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</h1>
<p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>

<div class="container">
<div class="categories" id="categoryContainer"></div>
<div class="products" id="productContainer"></div>
</div>

<div id="cartBar">
  <div style="flex:1; justify-content:center;">
    <span id="cartInfo"><strong style="color:black;">è¨‚å–®å°è¨ˆ</strong> <span style="color:red;">0 å…ƒ</span></span>
  </div>
  <div style="flex:1; justify-content:center;">
    <button id="viewCartBtn">ç¢ºèªçµå¸³</button>
  </div>
</div>

<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>
    <h3>è³¼ç‰©è»Š</h3>
    <div id="cartItems"></div>
    <p>ç¸½é¡ï¼š<span id="cartTotal">0</span> å…ƒ</p>

    <h4>ä»˜æ¬¾æ–¹å¼</h4>
    <select id="paymentMethod">
      <option value="ç¾é‡‘">ç¾é‡‘</option>
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="Line Pay">Line Pay</option>
    </select>

    <h4>å–è²¨æ–¹å¼</h4>
    <select id="deliveryMethod">
      <option value="" selected disabled>è«‹é¸æ“‡å–è²¨æ–¹å¼</option>
      <option value="è‡ªå–">è‡ªå–</option>
      <option value="å¤–é€">å¤–é€</option>
    </select>

    <div id="selfPickup" style="display:none;">
      <p>é¸æ“‡å–è²¨é–€å¸‚</p>
      <select id="pickupStore"></select>
    </div>

    <div id="deliveryForm" style="display:none;">
      <p>è«‹è¼¸å…¥æ”¶ä»¶è³‡è¨Š</p>
      <input type="text" id="receiverName" placeholder="å§“å"><br>
      <input type="text" id="receiverPhone" placeholder="é›»è©±"><br>
      <input type="text" id="receiverAddress" placeholder="åœ°å€"><br>
    </div>

    <button id="checkoutBtn">çµå¸³</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz_VaPxbndfTGn7AD7172q0WnqvqRW4c_corHHSQl4PS8L2xAQbt9vjr7hnGnhijkY/exec";
let products=[], categories=[], cart=[], userId="", userName="";
let pickupStores = [];

/* ---------- åˆå§‹åŒ– LIFF ---------- */
async function initLIFF(){
  await liff.init({ liffId:"2008573741-WGE2G7lZ" });
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
  } else liff.login();
}

/* ---------- æŠ“å•†å“è³‡æ–™ ---------- */
async function fetchProducts(){
  try{
    const res = await fetch(API_URL+"?action=products");
    products = await res.json();
    categories = [...new Set(products.map(p => p['é¡åˆ¥']))].filter(Boolean);
    renderCategories();
    if(categories[0]) renderProducts(categories[0]);

    const storeRes = await fetch(API_URL+"?action=stores");
    pickupStores = await storeRes.json();
    const storeSelect = document.getElementById("pickupStore");
    pickupStores.forEach(s=>{ 
      const opt=document.createElement("option"); 
      opt.value=s; 
      opt.textContent=s; 
      storeSelect.appendChild(opt); 
    });
  }catch(e){ console.error("æŠ“å–å•†å“æˆ–é–€å¸‚å¤±æ•—:", e); }
  document.getElementById("loadingOverlay").style.display="none"; // éš±è—è¼‰å…¥ä¸­
}

/* ---------- æ¸²æŸ“åˆ†é¡ ---------- */
function renderCategories(){
  const container = document.getElementById("categoryContainer");
  container.innerHTML="";
  categories.forEach(cat=>{
    const btn=document.createElement("button");
    btn.textContent=cat;
    btn.className="category-btn";
    btn.onclick=()=>{ 
      document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); 
      btn.classList.add("active"); 
      renderProducts(cat);
    }
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

/* ---------- æ¸²æŸ“å•†å“ (æ‰¹é‡æ’å…¥ + æ‡¶åŠ è¼‰) ---------- */
function renderProducts(category){
  const container = document.getElementById("productContainer");
  container.innerHTML="";
  const fragment = document.createDocumentFragment();

  products.filter(p => p['é¡åˆ¥']?.trim() === category?.trim())
  .forEach(p=>{
    const idName = encodeURIComponent(p['å•†å“åç¨±']);
    const card=document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <img src="${p['å•†å“ç…§ç‰‡']}" loading="lazy" alt="${p['å•†å“åç¨±']}">
      <h3>${p['å•†å“åç¨±']}</h3>
      <p>${p['ç‰¹è‰²èªªæ˜'] || ''}</p>
      <p>å–®ä½ï¼š${p['å–®ä½']}</p>
      <p class="price">${p['å”®åƒ¹']} å…ƒ</p>
      <p class="quantity-control">
        <button onclick="changeQty('${idName}',-1)">-</button>
        <span id="qty-${idName}">1</span>
        <button onclick="changeQty('${idName}',1)">+</button>
        <button class="add-cart" style="background:#B22222;color:white;" 
          onclick="addToCartWithAnimation('${idName}', this)">ğŸ›’
        </button>
      </p>
    `;
    fragment.appendChild(card);
  });

  container.appendChild(fragment);
}

/* ---------- æ•¸é‡æ§åˆ¶ ---------- */
function changeQty(idName, delta){
  const span = document.getElementById(`qty-${idName}`);
  let qty = parseInt(span.textContent);
  qty += delta; if(qty<1) qty=1;
  span.textContent = qty;
  span.style.transition = "transform 0.2s";
  span.style.transform = "scale(1.3)";
  setTimeout(() => { span.style.transform = "scale(1)"; }, 200);

  const name = decodeURIComponent(idName);
  const existIndex = cart.findIndex(c=>c.name===name);
  if(existIndex !== -1){ cart[existIndex].quantity = qty; updateCartBar(); }
}

/* ---------- åŠ å…¥è³¼ç‰©è»Š ---------- */
function addToCartWithAnimation(idName, btn){
  const name = decodeURIComponent(idName);
  const qty = parseInt(document.getElementById(`qty-${idName}`).textContent);
  const product = products.find(p=>p['å•†å“åç¨±']===name);
  const existIndex = cart.findIndex(c=>c.name===name);

  if(btn.classList.contains("active")){
    if(existIndex !== -1) cart.splice(existIndex,1);
    btn.classList.remove("active");
    btn.style.background = "#B22222";
  } else {
    if(existIndex !== -1) cart[existIndex].quantity += qty;
    else cart.push({name, price: parseInt(product['å”®åƒ¹']), quantity: qty, category: product['é¡åˆ¥']});
    btn.classList.add("active");
    btn.style.background = "#27ae60";
  }

  updateCartBar();
}

/* ---------- æ›´æ–°è³¼ç‰©è»Šæ¬„ä½ ---------- */
function updateCartBar(){
  const cartBar = document.getElementById("cartBar");
  if(cart.length===0){ cartBar.style.display="none"; return; }
  const totalAmt = cart.reduce((sum,i)=>sum+i.quantity*i.price,0);
  document.getElementById("cartInfo").innerHTML = `<strong style="color:black;">è¨‚å–®å°è¨ˆ</strong> <span style="color:red;">${totalAmt} å…ƒ</span>`;
  cartBar.style.display="flex";
}

/* ---------- è³¼ç‰©è»Š modal ---------- */
const cartModal = document.getElementById("cartModal");
document.getElementById("viewCartBtn").onclick = () => { renderCart(); cartModal.style.display="flex"; }
document.getElementById("cartClose").onclick = () => { cartModal.style.display="none"; }

function renderCart(){
  const container=document.getElementById("cartItems");
  container.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    const subtotal=item.price*item.quantity;
    total+=subtotal;
    const div=document.createElement("div");
    div.textContent=`${item.name} ${item.quantity} x ${item.price} = ${subtotal} å…ƒ`;
    container.appendChild(div);
  });
  document.getElementById("cartTotal").textContent=total;
  updateCartBar();
}

/* ---------- æŠ“ä½¿ç”¨è€…è³‡æ–™ ---------- */
async function fetchUserData() {
  if(!userId) return;
  const res = await fetch(API_URL+"?action=getUser&userId="+userId);
  const result = await res.json();
  if(result.user){
    document.getElementById("receiverName").value = result.user.name || "";
    document.getElementById("receiverPhone").value = result.user.phone || "";
    document.getElementById("receiverAddress").value = result.user.address || "";
  }
}

/* ---------- å–è²¨æ–¹å¼åˆ‡æ› ---------- */
document.getElementById("deliveryMethod").onchange = function(){
  const val = this.value;
  if(val === "è‡ªå–"){ 
    document.getElementById("selfPickup").style.display = "block"; 
    document.getElementById("deliveryForm").style.display = "none"; 
  } else if(val === "å¤–é€"){ 
    document.getElementById("selfPickup").style.display = "none"; 
    document.getElementById("deliveryForm").style.display = "block"; 
    fetchUserData(); 
  } else {
    document.getElementById("selfPickup").style.display = "none";
    document.getElementById("deliveryForm").style.display = "none";
  }
}

/* ---------- çµå¸³ ---------- */
document.getElementById("checkoutBtn").onclick = async function(){
  if(cart.length===0){ alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }

  const totalæˆ‘å·²ç¶“å®Œæ•´é–±è®€äº†ä½ çš„ HTML + CSS + JavaScript åŸå§‹ç¢¼ã€‚é€™æ˜¯ä¸€å€‹ã€Œç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸã€å‰ç«¯ç¯„ä¾‹ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

---

### 1ï¸âƒ£ ä¸»è¦åŠŸèƒ½æ¦‚è¦½
1. **ä½¿ç”¨ LINE LIFF ç™»å…¥**  
   - é€é LIFF SDK å–å¾—ä½¿ç”¨è€…åç¨±å’Œ userIdã€‚
   - ç™»å…¥å¾Œé¡¯ç¤º `æ‚¨å¥½, æœƒå“¡` â†’ `ä½¿ç”¨è€…åç¨± æ‚¨å¥½`ã€‚

2. **å•†å“èˆ‡åˆ†é¡å±•ç¤º**
   - å¾ Google Apps Script API (`API_URL`) å–å¾—å•†å“è³‡æ–™ã€‚
   - è‡ªå‹•ç”Ÿæˆåˆ†é¡æŒ‰éˆ•ï¼Œé»æ“Šåˆ†é¡å¾Œé¡¯ç¤ºè©²é¡åˆ¥å•†å“ã€‚
   - å•†å“å¡åŒ…å«ï¼š
     - å•†å“åœ–ç‰‡ã€åç¨±ã€ç‰¹è‰²èªªæ˜ã€å–®ä½ã€åƒ¹æ ¼
     - æ•¸é‡æ§åˆ¶ï¼ˆï¼‹/ï¼ æŒ‰éˆ•ï¼‰
     - åŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ•ï¼ˆå‹•ç•«æ•ˆæœï¼ŒåŠ å…¥å¾Œè®Šç¶ è‰²ï¼‰

3. **è³¼ç‰©è»Š**
   - åº•éƒ¨å›ºå®šæ¬„ä½é¡¯ç¤ºã€Œè¨‚å–®å°è¨ˆã€åŠã€Œç¢ºèªçµå¸³ã€æŒ‰éˆ•ã€‚
   - é»æ“Šã€Œç¢ºèªçµå¸³ã€é–‹å•Ÿ modal é¡¯ç¤ºè³¼ç‰©è»Šæ˜ç´°ã€‚
   - å¯é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼ˆç¾é‡‘ / ä¿¡ç”¨å¡ / Line Payï¼‰åŠå–è²¨æ–¹å¼ï¼ˆè‡ªå– / å¤–é€ï¼‰ã€‚
   - æ ¹æ“šå–è²¨æ–¹å¼é¡¯ç¤ºï¼š
     - è‡ªå– â†’ é¸æ“‡é–€å¸‚
     - å¤–é€ â†’ å¡«å¯«æ”¶ä»¶äººè³‡è¨Šï¼Œé‡‘é¡éœ€ â‰¥ 1500 å…ƒ

4. **çµå¸³æµç¨‹**
   - æª¢æŸ¥è³¼ç‰©è»Šæ˜¯å¦ç‚ºç©ºã€‚
   - é©—è­‰å–è²¨æ–¹å¼èˆ‡æ”¶ä»¶è³‡è¨Šå®Œæ•´æ€§ã€‚
   - POST è³‡æ–™è‡³ Google Apps Script API ä¸‹å–®ã€‚
   - ä¸‹å–®æˆåŠŸå¾Œï¼š
     - é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿ
     - æ¸…ç©ºè³¼ç‰©è»Š
     - é‡ç½®å•†å“æ•¸é‡ç‚º 1
     - è‹¥ API å›å‚³ flexMsg â†’ é€é LIFF å‚³é€ Line è¨Šæ¯

---

### 2ï¸âƒ£ UI è¨­è¨ˆé‡é»
- **æ•´é«”é¢¨æ ¼**
  - ä½¿ç”¨ Microsoft JhengHei å­—å‹ï¼ŒèƒŒæ™¯æŸ”å’Œ (#f5f5f5)
  - header èƒŒæ™¯è‰² #7ed6dfï¼Œæ–‡å­—ç™½è‰²
  - å•†å“å¡æœ‰é™°å½±å’Œåœ“è§’ï¼Œhover æœ‰å¾®å‹•ç•«
  - æ•¸é‡æ§åˆ¶æŒ‰éˆ•å’ŒåŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ•å¸¶æœ‰ App é¢¨æ ¼çš„ç¸®æ”¾å’Œé™°å½±

- **éŸ¿æ‡‰å¼è¨­è¨ˆ**
  - max-width 1200px
  - å°è¢å¹• (â‰¤600px) å•†å“å¡ç¸®å°ï¼Œåˆ†é¡æŒ‰éˆ•ç¸®å°ï¼Œheader å­—é«”ç¸®å°

- **åº•éƒ¨è³¼ç‰©è»Šæ¬„**
  - å›ºå®šåœ¨è¢å¹•ä¸‹æ–¹ï¼Œé«˜åº¦ 60px
  - å·¦å´é¡¯ç¤ºå°è¨ˆï¼Œå³å´æ”¾ã€Œç¢ºèªçµå¸³ã€æŒ‰éˆ•
  - æŒ‰éˆ•æ”¾å¤§ 20%ï¼Œhover é¡è‰²è®Šæ·±

- **Modal**
  - åŠé€æ˜èƒŒæ™¯ (#000 60%)
  - ä¸­å¤®ç™½è‰²å¡ç‰‡ï¼Œåœ“è§’ 12pxï¼Œæœ€å¤§é«˜åº¦ 90%ï¼Œå¯æ»¾å‹•
  - çµå¸³æŒ‰éˆ•å…¨å¯¬

---

### 3ï¸âƒ£ JavaScript é‚è¼¯
- **å…¨åŸŸè®Šæ•¸**
  ```js
  let products=[], categories=[], cart=[], userId="", userName="";
  let pickupStores = [];













































































































































































































































































































































































































































































































































































































































































































































































































































































































































<!DOCTYPE html> 
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</title>
<style>
body{font-family:"Microsoft JhengHei",Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;}
header{background:#8FD6C8;color:white;padding:1.2em;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
header h1{margin:0;font-size:1.6em;}
header p{margin:0.3em 0 0 0;font-size:0.95em;}
.container{width:95%;max-width:1200px;margin:1.5em auto;}
.categories{display:flex;gap:0.4em;flex-wrap:wrap;margin-bottom:1em;justify-content:center;}
.category-btn{padding:0.5em 1em;background:#eee;border:none;cursor:pointer;border-radius:20px;transition:0.3s;font-weight:500;font-size:0.9em;}
.category-btn:hover{background:#7ed6df;color:white;}
.category-btn.active{background:#7ed6df;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.8em;}
.product-card{background:white;border-radius:8px;padding:0.8em;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;flex-direction:column;transition:0.3s;position:relative;overflow:hidden;font-size:0.9em;border:2px solid #ff6b6b;}
.product-card:hover{transform:translateY(-2px);box-shadow:0 3px 12px rgba(0,0,0,0.2);}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px;transition:0.3s;}
.product-card:hover img{transform:scale(1.03);}
.product-card h3{margin:0.4em 0 0.2em 0;font-size:1em;}
.product-card p{margin:0.2em 0;font-size:0.85em;color:#555;}
.product-card .price{font-weight:bold;color:#ff6b6b;margin-top:0.4em;}
.quantity-control{margin:0.4em 0;display:flex;align-items:center;gap:5px;justify-content:flex-start;}
.quantity-control button{width:32px;height:32px;border:none;background:#7ed6df;color:white;border-radius:4px;cursor:pointer;font-weight:bold;}
.quantity-control span{min-width:28px;text-align:center;display:inline-block;font-weight:bold;}
.add-cart {
    width:36px;
    height:36px;
    border-radius:6px;
    background:#b23838 !important; 
    color:white;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.2em;
    border:none;
    cursor:pointer;
    transition:0.3s;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.add-cart.active {
    background:#4CAF50 !important;
    color:white;
    box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
#cartBar {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    background:#4CAF50; 
    color:white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8em 1em;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
    font-weight: bold;
    font-size: 0.95em;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    display: none;
    transition: transform 0.2s ease;
}
#cartBar.flash {
    transform: scale(1.1);
}
#cartBar span#cartInfo {
    display: flex;
    align-items: center;
    gap: 0.5em;
}
#cartBar button#viewCartBtn {
    background:#b23838;
    border:none;
    padding:0.5em 1em;
    border-radius:6px;
    color:white;
    cursor:pointer;
    font-weight:bold;
    transition:0.3s;
}
#cartBar button#viewCartBtn:hover { background:#ff4d4d; }
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:flex-start;padding-top:5%;z-index:9999;}
.modal-content{background:white;padding:1.5em;border-radius:12px;max-height:90%;overflow-y:auto;width:95%;position:relative;font-size:0.9em;}
.modal-close{position:absolute;top:10px;right:12px;cursor:pointer;color:red;font-weight:bold;font-size:1.2em;}
#cartItems div{padding:0.3em 0;border-bottom:1px solid #eee;}
#cartItems div:last-child{border:none;}
select,input{width:100%;padding:0.5em;margin:0.2em 0;border-radius:6px;border:1px solid #ccc;font-size:0.9em;}
button#checkoutBtn{width:100%;padding:0.6em;margin-top:0.6em;border:none;border-radius:8px;background:#7ed6df;color:white;font-weight:bold;cursor:pointer;font-size:1em;}
button#checkoutBtn:hover{background:#63c5b5;}
#selfPickup, #deliveryForm{margin-top:0.5em;}
@media (max-width:600px){
.products{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.6em;}
.product-card img{height:120px;}
.category-btn{padding:0.5em 0.8em;font-size:0.85em;}
header h1{font-size:1.4em;}
header p{font-size:0.85em;}
}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
<h1>ç”Ÿé®®è”¬æœè³¼ç‰©å•†åŸ</h1>
<p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>

<div class="container">
<div class="categories" id="categoryContainer"></div>
<div class="products" id="productContainer"></div>
</div>

<div id="cartBar">
  <span id="cartInfo">ğŸ›’ 0 ä»¶ | 0 å…ƒ</span>
  <button id="viewCartBtn">æŸ¥çœ‹è³¼ç‰©è»Š / çµå¸³</button>
</div>

<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>
    <h3>è³¼ç‰©è»Š</h3>
    <div id="cartItems"></div>
    <p>ç¸½é¡ï¼š<span id="cartTotal">0</span> å…ƒ</p>

    <h4>ä»˜æ¬¾æ–¹å¼</h4>
    <select id="paymentMethod">
      <option value="ç¾é‡‘">ç¾é‡‘</option>
      <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
      <option value="Line Pay">Line Pay</option>
    </select>

    <h4>å–è²¨æ–¹å¼</h4>
    <select id="deliveryMethod">
      <option value="" selected disabled>è«‹é¸æ“‡å–è²¨æ–¹å¼</option>
      <option value="è‡ªå–">è‡ªå–</option>
      <option value="å¤–é€">å¤–é€</option>
    </select>

    <div id="selfPickup" style="display:none;">
      <p>é¸æ“‡å–è²¨é–€å¸‚</p>
      <select id="pickupStore"></select>
    </div>

    <div id="deliveryForm" style="display:none;">
      <p>è«‹è¼¸å…¥æ”¶ä»¶è³‡è¨Š</p>
      <input type="text" id="receiverName" placeholder="å§“å"><br>
      <input type="text" id="receiverPhone" placeholder="é›»è©±"><br>
      <input type="text" id="receiverAddress" placeholder="åœ°å€"><br>
    </div>

    <button id="checkoutBtn">âœ… çµå¸³</button>
  </div>
</div>
    <div id="orderDetailPage" style="display:none;padding:20px;">
  <h2>è¨‚å–®æ˜ç´°</h2>
  <div id="orderDetailContent"></div>
  <button onclick="closeOrderDetail()">è¿”å›</button>
</div>
    </div>
    <div id="cartBar">
  <span id="cartInfo"></span>
  <span id="cartBadge" style="background:red;color:white;border-radius:50%;padding:2px 6px;position:absolute;top:-5px;right:-5px;display:none;"></span>
  <button id="viewCartBtn">æŸ¥çœ‹è³¼ç‰©è»Š</button>
</div>


<script>
const API_URL ="https://script.google.com/macros/s/AKfycbxKX90zhCBU9cIyqeuysbZTgvCLHe7WmP4qlABw_6zIFYHqJi9fG1Rv4Jjfqd4raqNN/exec";
let products=[], cart=[], userId="", userName="", pickupStores=[];

// ===== LIFF åˆå§‹åŒ– =====
async function initLIFF(){
  await liff.init({ liffId:"2008573741-WGE2G7lZ" });
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
    fetchUserData();
  } else liff.login();
}

// ===== å–å¾—å•†å“èˆ‡é–€å¸‚ =====
async function fetchProducts(){
  const res = await fetch(API_URL+"?action=products");
  products = await res.json();
  renderProducts(products);

  const storeRes = await fetch(API_URL+"?action=stores");
  pickupStores = await storeRes.json();
  const storeSelect = document.getElementById("pickupStore");
  pickupStores.forEach(s=>{
    const opt=document.createElement("option");
    opt.value=s; opt.textContent=s;
    storeSelect.appendChild(opt);
  });
}

// ===== çµå¸³ =====
document.getElementById("checkoutBtn").onclick = async function(){
  if(cart.length===0){ alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }

  const deliveryMethod = document.getElementById("deliveryMethod").value;
  let shippingFee=0, receiverName="", receiverPhone="", receiverAddress="", pickupStore="";

  if(deliveryMethod==="å¤–é€"){
    receiverName=document.getElementById("receiverName").value;
    receiverPhone=document.getElementById("receiverPhone").value;
    receiverAddress=document.getElementById("receiverAddress").value;
    if(!receiverName||!receiverPhone||!receiverAddress){ alert("è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶è³‡è¨Š"); return; }
  } else {
    pickupStore=document.getElementById("pickupStore").value;
    if(!pickupStore){ alert("è«‹é¸æ“‡å–è²¨é–€å¸‚"); return; }
  }

  const totalAmount = cart.reduce((sum,i)=>sum+i.price*i.quantity,0);
  const paymentMethod=document.getElementById("paymentMethod").value;

  const data={ 
    userId,userName,totalAmount,shippingFee,paymentMethod,
    deliveryMethod,receiverName,receiverPhone,receiverAddress,pickupStore,
    items:cart
  };

  try{
    const resOrder = await fetch(API_URL,{method:'POST',body:JSON.stringify(data)});
    const resultOrder = await resOrder.json();

    // ===== å‚³é€ LIFF è¨Šæ¯ =====
    const flex = buildOrderFlex({ ...data, orderId: resultOrder.orderId });
    await liff.sendMessages([{
      type:"flex",
      altText:`è¨‚å–® ${resultOrder.orderId}`,
      contents:flex.contents
    }]);

    alert("è¨‚å–®å®Œæˆï¼Œå·²å‚³é€è‡³ LINE");

    // ===== æ¸…ç©ºè³¼ç‰©è»Š =====
    cart=[]; updateCartBar();
  }catch(e){
    console.error(e);
    alert("è¨‚å–®å·²å»ºç«‹ï¼Œä½†å‚³é€ LINE è¨Šæ¯å¤±æ•—");
  }
};

// ===== Flex è¨‚å–®å¡ç‰‡ =====
function buildOrderFlex(order){
  const itemBoxes = order.items.map(i=>({
    type:"box",
    layout:"horizontal",
    spacing:"sm",
    contents:[
      { type:"text", text:i.name, size:"sm", flex:5, wrap:true },
      { type:"text", text:`${i.quantity} x ${i.price}`, size:"sm", flex:2, align:"end" },
      { type:"text", text:`${i.quantity*i.price}`, size:"sm", flex:2, align:"end", weight:"bold" }
    ]
  }));

  return {
    type:"flex",
    altText:`è¨‚å–® ${order.orderId}`,
    contents:{
      type:"bubble",
      size:"mega",
      header:{ type:"box", layout:"vertical", contents:[
        { type:"text", text:"è¨‚å–®æ˜ç´°", weight:"bold", size:"xl" },
        { type:"text", text:`è¨‚å–®ç·¨è™Ÿï¼š${order.orderId}`, size:"sm", color:"#888" }
      ]},
      body:{ type:"box", layout:"vertical", spacing:"md", contents:[
        { type:"text", text:`å–è²¨æ–¹å¼ï¼š${order.deliveryMethod}`, size:"sm" },
        ...(order.deliveryMethod==="å¤–é€"?[
          { type:"text", text:`æ”¶ä»¶äººï¼š${order.receiverName}`, size:"sm" },
          { type:"text", text:`é›»è©±ï¼š${order.receiverPhone}`, size:"sm" },
          { type:"text", text:`åœ°å€ï¼š${order.receiverAddress}`, size:"sm", wrap:true }
        ]:[
          { type:"text", text:`é–€å¸‚ï¼š${order.pickupStore}`, size:"sm" }
        ]),
        { type:"separator", margin:"md" },
        { type:"box", layout:"vertical", spacing:"xs", contents:itemBoxes },
        { type:"separator", margin:"md" },
        { type:"box", layout:"horizontal", contents:[
          { type:"text", text:"ç¸½é‡‘é¡", size:"md", weight:"bold", flex:6 },
          { type:"text", text:`${order.totalAmount} å…ƒ`, size:"md", weight:"bold", align:"end", flex:4 }
        ]}
      ]},
      footer:{ type:"box", layout:"horizontal", contents:[
        { type:"button", style:"primary", action:{ type:"uri", label:"æŸ¥çœ‹è¨‚å–®", uri: window.location.href }, color:"#27ae60" }
      ]}
    }
  };
}

// ===== åˆå§‹åŒ– =====
initLIFF().then(fetchProducts);
</script>



</body>
</html>











































































































































































































































































































































































































































































































































































































































































































































































































































































































































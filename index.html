<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>專業購物商城</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
header { background:#4CAF50; color:white; padding:1em; text-align:center; }
.container { width:90%; max-width:1200px; margin:2em auto; }
.categories { display:flex; gap:1em; flex-wrap:wrap; margin-bottom:2em; }
.category-btn { padding:0.5em 1em; background:#eee; border:none; cursor:pointer; border-radius:4px; }
.category-btn.active { background:#4CAF50; color:white; }
.products { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1em; }
.product-card { background:white; border-radius:4px; padding:1em; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.product-card img { width:100%; height:150px; object-fit:cover; border-radius:4px; }
.product-card h3 { margin:0.5em 0 0.3em 0; font-size:1.1em; }
.product-card p { margin:0.2em 0; font-size:0.9em; color:#555; }
.product-card .price { font-weight:bold; color:#E91E63; margin-top:0.5em; }
.cart { margin-top:2em; background:#fff; padding:1em; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.cart-item { display:flex; justify-content:space-between; margin-bottom:0.5em; }
#pickupDiv { display:none; margin-top:0.5em; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <h1>專業購物商城</h1>
  <p id="greeting">您好, 會員</p>
</header>
<div class="container">
  <div class="categories" id="categoryContainer"></div>
  <div class="products" id="productContainer"></div>

  <div class="cart" id="cartContainer">
    <h3>購物車</h3>
    <div id="cartItems"></div>
    <hr>
    <p>姓名: <input type="text" id="memberName"></p>
    <p>電話: <input type="text" id="memberPhone"></p>
    <p>地址: <input type="text" id="memberAddress"></p>

    <label>取貨方式
      <select id="delivery" onchange="togglePickup()">
        <option value="自取">自取</option>
        <option value="外送">外送</option>
      </select>
    </label>

    <div id="pickupDiv">
      <label>取貨門市
        <select id="pickupStore"></select>
      </label>
    </div>

    <p>付款方式
      <select id="payment">
        <option value="現金">現金</option>
        <option value="轉帳 / ATM">轉帳 / ATM</option>
        <option value="LINE Pay">LINE Pay</option>
        <option value="貨到付款">貨到付款</option>
        <option value="刷卡">刷卡</option>
      </select>
    </p>
    <button onclick="confirmOrder()">確認下單</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxhiI-UeuQsYM9x7WmuXS_ZtLKOrRSlZFO_oth3ICg_WgmDhvYgOyTOCwnGgAy0eJBJ/exec"; // <-- 替換你的 GAS Web App URL
let products = [], categories = [], cart = [], USER_ID = "";

// LIFF 初始化
async function initLIFF() {
  await liff.init({ liffId: "2008573741-WGE2G7lZ" }); 
  if (liff.isLoggedIn()) {
    const profile = await liff.getProfile();
    USER_ID = profile.userId;
    setGreeting(profile.displayName);
  } else liff.login();
}

function setGreeting(name){ document.getElementById("greeting").textContent = `${name} 您好`; }

// 取得商品清單
async function fetchProducts(){
  const res = await fetch(API_URL);
  products = await res.json();
  products.forEach(p=>{
    if(p['商品照片']){
      const match = p['商品照片'].match(/([^\/]+)$/);
      if(match) p['商品照片'] = `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }
  });
  categories = [...new Set(products.map(p=>p['類別']))];
  renderCategories();
  renderProducts(categories[0]);
}

function renderCategories(){
  const container = document.getElementById("categoryContainer");
  container.innerHTML = "";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.className = "category-btn";
    btn.onclick = ()=>{ document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); renderProducts(cat); };
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

function renderProducts(category){
  const container = document.getElementById("productContainer");
  container.innerHTML = "";
  products.filter(p=>p['類別']===category).forEach(p=>{
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <img src="${p['商品照片'] || ''}" alt="${p['商品名稱']}">
      <h3>${p['商品名稱']}</h3>
      <p>${p['特色說明'] || ''}</p>
      <p class="price">${p['售價'] || ''}</p>
      <p>單位: ${p['單位'] || ''}</p>
      <p>數量: <input type="number" value="1" min="1" id="qty-${p['商品名稱']}"></p>
      <button onclick="addToCart('${p['商品名稱']}', ${parseFloat(p['售價']) || 0})">加入購物車</button>
    `;
    container.appendChild(card);
  });
}

function addToCart(name, price){
  const qty = parseInt(document.getElementById(`qty-${name}`).value);
  const exist = cart.find(i=>i.name===name);
  if(exist){ exist.qty += qty; } else { cart.push({name, price, qty}); }
  renderCart();
}

function renderCart(){
  const container = document.getElementById("cartItems");
  container.innerHTML = "";
  cart.forEach(item=>{
    const div = document.createElement("div");
    div.className = "cart-item";
    div.textContent = `${item.name} x ${item.qty} = ${item.price*item.qty}`;
    container.appendChild(div);
  });
}

// 取貨方式
async function togglePickup(){
  const delivery = document.getElementById("delivery").value;
  const pickupDiv = document.getElementById("pickupDiv");
  if(delivery==="自取"){ pickupDiv.style.display="block"; await loadPickupStores(); }
  else pickupDiv.style.display="none";
}

// 取得門市列表
async function loadPickupStores(){
  const res = await fetch(`${API_URL}?market=1`);
  const stores = await res.json();
  const select = document.getElementById("pickupStore");
  select.innerHTML = "";
  stores.forEach(store=>{
    const opt = document.createElement("option");
    opt.value = store;
    opt.textContent = store;
    select.appendChild(opt);
  });
}

// 確認下單
async function confirmOrder(){
  const name = document.getElementById("memberName").value;
  const phone = document.getElementById("memberPhone").value;
  const address = document.getElementById("memberAddress").value;
  const delivery = document.getElementById("delivery").value;
  const payment = document.getElementById("payment").value;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  let pickupStore = "";
  if(delivery==="外送" && total<1500){ return alert("外送訂單需滿 NT$1500"); }
  if(delivery==="自取") pickupStore = document.getElementById("pickupStore").value;

  const res = await fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({ userId:USER_ID, name, phone, address, delivery, pickupStore, payment, cart, total, orderTime:new Date() })
  });
  const data = await res.json();
  alert("訂單完成");
  document.getElementById("modalContent").innerHTML = `<h3>取貨 QR Code</h3><img src="${data.qrCode}" style="width:220px;">`;
  cart = [];
  renderCart();
}

initLIFF();
fetchProducts();
</script>
</body>
</html>

















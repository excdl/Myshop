<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°ˆæ¥­è³¼ç‰©å•†åŸ</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f9f9f9;}
header { background:#4CAF50; color:white; padding:1em; text-align:center;}
.container { width:90%; max-width:1200px; margin:2em auto;}
.categories { display:flex; gap:1em; flex-wrap:wrap; margin-bottom:2em; }
.category-btn { padding:0.5em 1em; background:#eee; border:none; cursor:pointer; border-radius:4px;}
.category-btn.active { background:#4CAF50; color:white;}
.products { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1em; }
.product-card { background:white; border-radius:4px; padding:1em; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.product-card img { width:100%; height:150px; object-fit:cover; border-radius:4px;}
.product-card h3 { margin:0.5em 0 0.3em 0; font-size:1.1em;}
.product-card p { margin:0.2em 0; font-size:0.9em; color:#555;}
.product-card .price { font-weight:bold; color:#E91E63; margin-top:0.5em;}
.cart { position:fixed; right:20px; bottom:20px; background:#E91E63; color:white; padding:1em; border-radius:50%; cursor:pointer; font-weight:bold;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;}
.modal-content { background:white; padding:2em; border-radius:8px; max-height:90%; overflow-y:auto; width:90%; max-width:500px;}
.modal-close { float:right; cursor:pointer; color:red; font-weight:bold; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
<h1>å°ˆæ¥­è³¼ç‰©å•†åŸ</h1>
<p id="greeting">æ‚¨å¥½, æœƒå“¡</p>
</header>
<div class="container">
  <div class="categories" id="categoryContainer"></div>
  <div class="products" id="productContainer"></div>
</div>
<div class="cart" id="cartBtn">ğŸ›’</div>

<div class="modal" id="cartModal">
  <div class="modal-content">
    <span class="modal-close" id="cartClose">&times;</span>
    <h3>è³¼ç‰©è»Š</h3>
    <div id="cartItems"></div>
    <p>ç¸½é¡ï¼š<span id="cartTotal">0</span> å…ƒ</p>
    <button id="checkoutBtn">çµå¸³</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxeYrwSQV3HJfZfd7d75Y8EVbnEt0ueiZhffhTA6f2St8qMw1in6bVP-_ATjll18hUi/exec";
let products=[], categories=[], cart=[], userId="", userName="";

async function initLIFF(){
  await liff.init({ liffId: "2008573741-WGE2G7lZ" });
  if(liff.isLoggedIn()){
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("greeting").textContent = `${userName} æ‚¨å¥½`;
  } else { liff.login(); }
}

async function fetchProducts(){
  try{
    const res = await fetch(API_URL);
    products = await res.json();
    categories = [...new Set(products.map(p=>p['é¡åˆ¥']))];
    renderCategories();
    renderProducts(categories[0]);
  } catch(e){ alert("ç„¡æ³•å–å¾—å•†å“æ¸…å–®"); console.error(e);}
}

function renderCategories(){
  const container = document.getElementById("categoryContainer");
  container.innerHTML="";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.className="category-btn";
    btn.onclick=()=>{ document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); renderProducts(cat);}
    container.appendChild(btn);
  });
  if(container.firstChild) container.firstChild.classList.add("active");
}

function renderProducts(category){
  const container = document.getElementById("productContainer");
  container.innerHTML="";
  products.filter(p=>p['é¡åˆ¥']===category).forEach(p=>{
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML = `
      <img src="${p['å•†å“ç…§ç‰‡']||''}" alt="${p['å•†å“åç¨±']}">
      <h3>${p['å•†å“åç¨±']}</h3>
      <p>${p['ç‰¹è‰²èªªæ˜']||''}</p>
      <p>å–®ä½ï¼š${p['å–®ä½']}</p>
      <p class="price">${p['å”®åƒ¹']} å…ƒ</p>
      <p>æ•¸é‡ï¼š
        <input type="number" min="1" value="1" id="qty-${p['å•†å“åç¨±']}">
      </p>
      <button onclick="addToCart('${p['å•†å“åç¨±']}')">åŠ å…¥è³¼ç‰©è»Š</button>
    `;
    container.appendChild(card);
  });
}

function addToCart(name){
  const product = products.find(p=>p['å•†å“åç¨±']===name);
  const qty = parseInt(document.getElementById(`qty-${name}`).value);
  const exist = cart.find(c=>c.name===name);
  if(exist){ exist.quantity += qty; } else { cart.push({name, price:parseInt(product['å”®åƒ¹']), quantity:qty, category:product['é¡åˆ¥'], productType:product['ç”¢å“é¡å‹']}); }
  alert(`${name} å·²åŠ å…¥è³¼ç‰©è»Š`);
}

const cartBtn = document.getElementById("cartBtn");
const cartModal = document.getElementById("cartModal");
const cartClose = document.getElementById("cartClose");
cartBtn.onclick = ()=>{ renderCart(); cartModal.style.display="flex"; }
cartClose.onclick = ()=>{ cartModal.style.display="none"; }

function renderCart(){
  const container = document.getElementById("cartItems");
  container.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    const subtotal = item.price*item.quantity;
    total += subtotal;
    const div = document.createElement("div");
    div.textContent=`${item.name} ${item.quantity} x ${item.price} = ${subtotal} å…ƒ`;
    container.appendChild(div);
  });
  document.getElementById("cartTotal").textContent = total;
}

document.getElementById("checkoutBtn").onclick = async function(){
  if(cart.length===0){ alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
  // ç°¡åŒ–ç¤ºç¯„ï¼Œé€™è£¡å¯å¢åŠ ä»˜æ¬¾æ–¹å¼ã€å–è²¨æ–¹å¼ã€æœƒå“¡è¨»å†Šè¡¨å–®ç­‰
  const totalAmount = cart.reduce((sum,i)=>sum+i.price*i.quantity,0);
  const data = { userId, userName, totalAmount, items: cart };
  const res = await fetch(API_URL, { method:'POST', body:JSON.stringify(data) });
  const result = await res.json();
  alert("è¨‚å–®å®Œæˆï¼Œå–®è™Ÿï¼š"+result.orderId);
  cart=[]; cartModal.style.display="none";
}

initLIFF();
fetchProducts();
</script>
</body>
</html>








